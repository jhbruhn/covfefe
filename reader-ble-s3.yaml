esphome:
  name: covfefe-reader
  includes:
    - <log.h>
    - "log.h"
  project:
    version: dev # This will be replaced by the github workflows with the `release` version
    
substitutions:
  printer_mac: "88:56:A6:63:06:22"
  consumptions_until_report: 128
  name_storage_size: 32
  print_service_id: fa751408-65b2-4505-881e-e0cd1b8f9c2a
  print_characteristic_id: fb286ed0-e4c6-4da3-a304-f5791f95bf20

esp32:
  # Use any ESP32 variant you have
  variant: esp32s3
  framework:
    type: esp-idf
    advanced:
      compiler_optimization: PERF

# Enable logging
logger:
  level: DEBUG
  baud_rate: 9600

wifi:
  power_save_mode: none
  enable_on_boot: True
  output_power: 8.5
  ap:
    ssid: "Covfefe Leser"
    password: "Computertomograph!"
  on_connect:
    - component.update: http_firmware_update

time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Berlin
    servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
      - 2.pool.ntp.org
    on_time:
      - days_of_week: MON
        hours: 9
        minutes: 0
        seconds: 0
        then:
          - script.execute: print_consumption_report
      - hours: 0
        minutes: 0
        seconds: 0
        then:
          - lambda: id(new_day) = true;

captive_portal:

globals:
  - id: consumptions
    type: std::array<uint32_t, ${name_storage_size}>
    restore_value: yes
    initial_value: ""
  - id: total_consumptions
    type: int32_t
    restore_value: yes
    initial_value: "0"
  - id: cleanings
    type: std::array<uint32_t, ${name_storage_size}>
    restore_value: yes
    initial_value: ""
  - id: cleaning_times
    type: std::array<ESPTime, ${name_storage_size}>
    restore_value: yes
    initial_value: ""
  - id: consumption_times
    type: std::array<ESPTime, ${name_storage_size}>
    restore_value: yes
    initial_value: ""
  - id: total_cleanings
    type: int32_t
    restore_value: yes
    initial_value: "0"
  - id: names
    type: std::array<NameEntry, ${name_storage_size}>
    restore_value: yes
    initial_value: ""
  - id: total_names
    type: int32_t
    restore_value: yes
    initial_value: "0"
  - id: last_cleaning_time
    type: ESPTime
    restore_value: yes
    initial_value: ""
  - id: new_day
    type: bool
    restore_value: yes
    initial_value: "true"
  - id: coffees_since_last_cleaning
    type: int32_t
    restore_value: yes
    initial_value: "0"
  - id: total_refills
    type: int32_t
    restore_value: yes
    initial_value: "0"
  - id: last_refill_time
    type: ESPTime
    restore_value: yes
    initial_value: ""
  - id: coffees_since_last_refill
    type: int32_t
    restore_value: yes
    initial_value: "0"
  - id: refill_period_consumptions
    type: std::array<uint32_t, ${name_storage_size}>
    restore_value: yes
    initial_value: ""
  - id: print_buffer
    type: std::vector<uint8_t>
    restore_value: no
  - id: print_offset
    type: size_t
    restore_value: no
    initial_value: "0"

i2c:
  sda: GPIO4
  scl: GPIO5

pn532_i2c:
  update_interval: 1s
  on_tag:
    then:
      - light.turn_off:
          id: led
      - lambda: |
          if (tag.has_ndef_message()) {
            auto message = tag.get_ndef_message();
            auto records = message->get_records();
            for (auto &record : records) {
              std::string payload = record->get_payload();
              std::string type = record->get_type();

              if (type == "T") {
                if (payload == "@@CLEAN@@") {
                  id(log_cleaning_switch).turn_on();
                } else if (payload == "@@CONSUMPTIONREPORT@@") {
                  id(print_consumption_report)->execute();
                } else if (payload == "@@CLEANINGREPORT@@") {
                  id(print_cleaning_report)->execute();
                } else if (payload == "@@REFILL@@") {
                  id(log_refill)->execute();
                } else {
                  if(id(log_cleaning_switch).state) {
                    id(log_cleaning)->execute(payload);
                    id(log_cleaning_switch).turn_off();
                  } else {
                    id(log_coffee)->execute(payload);
                  }
                }
              }
            }
          }
output:
  - platform: ledc
    pin: GPIO9
    id: buzzer

rtttl:
  output: buzzer

switch:
  - platform: template
    id: log_cleaning_switch
    optimistic: true
    turn_on_action:
      - rtttl.play: "scale_up:d=32,o=5,b=100:c,c#,d#,e,f#,g#,a#,b"
      - light.turn_on:
          id: led
          effect: pulse
          blue: 100%
          red: 100%
          green: 0
      - delay: 15s
      - if:
          condition:
            switch.is_on: log_cleaning_switch
          then:
            - switch.turn_off: log_cleaning_switch
            - rtttl.play: "scale_up:d=32,o=5,b=100:b,a#,g#,f#,e,d#,c#,c"

    turn_off_action:
      - light.turn_off:
          id: led

light:
  - platform: esp32_rmt_led_strip
    rgb_order: GRB
    pin: GPIO10
    num_leds: 1
    max_refresh_rate: 16ms
    chipset: ws2812
    id: led
    flash_transition_length: 500ms
    effects:
      - pulse:
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%

esp32_ble_tracker:
#  scan_parameters:
#    continuous: false

ota:
  - platform: http_request

http_request:

update:
  - platform: http_request
    name: Firmware Update
    id: http_firmware_update
    source: https://jhbruhn.github.io/covfefe/firmware/covfefe-reader.manifest.json
    on_update_available:
      - light.turn_on:
          id: led
          effect: pulse
          blue: 100%
          red: 0
          green: 0
      - update.perform:

esp32_ble_server:
  manufacturer: "Covfefe"
  model: "Coffee Reader BLE-S3"
  services:
    - uuid: 'c0ffee00-0000-1000-8000-00805f9b34fb'
      advertise: true
      characteristics:
        # Total coffee consumptions
        - id: ble_total_consumptions
          uuid: 'c0ffee01-0000-1000-8000-00805f9b34fb'
          description: "Total Coffee Consumptions"
          read: true
          notify: true
          value:
            data: !lambda |-
              return bytebuffer::ByteBuffer::wrap((uint32_t)id(total_consumptions)).get_data();
        
        # Total cleanings
        - id: ble_total_cleanings
          uuid: 'c0ffee02-0000-1000-8000-00805f9b34fb'
          description: "Total Cleanings"
          read: true
          notify: true
          value:
            data: !lambda |-
              return bytebuffer::ByteBuffer::wrap((uint32_t)id(total_cleanings)).get_data();
        
        # Total refills
        - id: ble_total_refills
          uuid: 'c0ffee03-0000-1000-8000-00805f9b34fb'
          description: "Total Refills"
          read: true
          notify: true
          value:
            data: !lambda |-
              return bytebuffer::ByteBuffer::wrap((uint32_t)id(total_refills)).get_data();
        
        # Coffees since last cleaning
        - id: ble_coffees_since_cleaning
          uuid: 'c0ffee04-0000-1000-8000-00805f9b34fb'
          description: "Coffees Since Last Cleaning"
          read: true
          notify: true
          value:
            data: !lambda |-
              return bytebuffer::ByteBuffer::wrap((uint32_t)id(coffees_since_last_cleaning)).get_data();
        
        # Coffees since last refill
        - id: ble_coffees_since_refill
          uuid: 'c0ffee05-0000-1000-8000-00805f9b34fb'
          description: "Coffees Since Last Refill"
          read: true
          notify: true
          value:
            data: !lambda |-
              return bytebuffer::ByteBuffer::wrap((uint32_t)id(coffees_since_last_refill)).get_data();
        
        # Total registered users
        - id: ble_total_users
          uuid: 'c0ffee06-0000-1000-8000-00805f9b34fb'
          description: "Total Registered Users"
          read: true
          notify: true
          value:
            data: !lambda |-
              return bytebuffer::ByteBuffer::wrap((uint32_t)id(total_names)).get_data();
        
        # Coffee consumption leaderboard
        # Format: [count:4][karma:4][timestamp:4][name_len:1][name:name_len]...
        # Sorted by consumption count (descending)
        - id: ble_consumption_leaderboard
          uuid: 'c0ffee07-0000-1000-8000-00805f9b34fb'
          description: "Coffee Consumption Leaderboard"
          read: true
          value:
            data: !lambda |-
              auto leaderboard = build_leaderboard(
                id(names), 
                id(consumptions), 
                id(consumptions), 
                id(cleanings),
                id(consumption_times),
                id(total_names)
              );
              return encode_leaderboard_binary(leaderboard);
        
        # Cleaning leaderboard
        # Format: [count:4][karma:4][timestamp:4][name_len:1][name:name_len]...
        # Sorted by cleaning count (descending)
        - id: ble_cleaning_leaderboard
          uuid: 'c0ffee08-0000-1000-8000-00805f9b34fb'
          description: "Cleaning Leaderboard"
          read: true
          value:
            data: !lambda |-
              auto leaderboard = build_leaderboard(
                id(names), 
                id(cleanings), 
                id(consumptions), 
                id(cleanings),
                id(cleaning_times),
                id(total_names)
              );
              return encode_leaderboard_binary(leaderboard);
        
        # Last cleaning timestamp (Unix epoch)
        - id: ble_last_cleaning_time
          uuid: 'c0ffee09-0000-1000-8000-00805f9b34fb'
          description: "Last Cleaning Timestamp"
          read: true
          notify: true
          value:
            data: !lambda |-
              uint32_t timestamp = 0;
              if (id(last_cleaning_time).is_valid()) {
                timestamp = id(last_cleaning_time).timestamp;
              }
              return bytebuffer::ByteBuffer::wrap(timestamp).get_data();
        
        # Last refill timestamp (Unix epoch)
        - id: ble_last_refill_time
          uuid: 'c0ffee0a-0000-1000-8000-00805f9b34fb'
          description: "Last Refill Timestamp"
          read: true
          notify: true
          value:
            data: !lambda |-
              uint32_t timestamp = 0;
              if (id(last_refill_time).is_valid()) {
                timestamp = id(last_refill_time).timestamp;
              }
              return bytebuffer::ByteBuffer::wrap(timestamp).get_data();

ble_client:
  - mac_address: ${printer_mac}
    id: printer_ble
    auto_connect: true

script:
  - id: transmit_print
    parameters:
      message: uint8_t[]
    mode: single
    then:
      - lambda: |-
          id(print_buffer) = message;
          id(print_offset) = 0;
          ESP_LOGD("BLE", "Transmitting %d bytes in chunks", message.size());
      - delay: 100ms
      - while:
          condition:
            lambda: "return id(print_offset) < id(print_buffer).size();"
          then:
            - ble_client.ble_write:
                id: printer_ble
                service_uuid: ${print_service_id}
                characteristic_uuid: ${print_characteristic_id}
                value: !lambda |-
                  size_t chunk_size = std::min((size_t)20, id(print_buffer).size() - id(print_offset));
                  std::vector<uint8_t> chunk(
                    id(print_buffer).begin() + id(print_offset),
                    id(print_buffer).begin() + id(print_offset) + chunk_size
                  );
                  ESP_LOGD("BLE", "Sending chunk at offset %d, size %d", id(print_offset), chunk_size);
                  id(print_offset) += chunk_size;
                  return chunk;
            - delay: 50ms
      - delay: 50ms

  - id: log_cleaning
    parameters:
      name: string
    then:
      - logger.log: "Logging Cleaning Consumption"
      - rtttl.play: "cantina:d=8,o=5,b=250,b=250:a,p,d6,p,a,p,d6,p,a,d6,p,a,p,g#,4a,a,g#,a,4g,f#,g,f#,4f.,d.,16p,4p.,a,p,d6,p,a,p,d6,p,a,d6,p,a,p,g#,a,p,g,p,4g.,f#,g,p,c6,4a#,4a,4g"
      - lambda: |-
          size_t name_index = get_name_index(id(names), name);
          if (name_index == -1) {
            name_index = id(total_names)++;
            id(names)[name_index].set_name(name.c_str());
          }
          id(cleanings)[name_index]++;
          id(cleaning_times)[name_index] = id(sntp_time).now();
          id(total_cleanings) += 1;
      # Notify BLE clients of updated values
      - ble_server.characteristic.notify:
          id: ble_total_cleanings
      - ble_server.characteristic.notify:
          id: ble_last_cleaning_time
      - script.wait: transmit_print
      - script.execute:
          id: transmit_print
          message: !lambda |-
            std::vector<uint8_t> escpos_data;

            //// ESC @ - Initialize printer
            escpos_data.push_back(0x1B);
            escpos_data.push_back(0x40);

            // ESC a 1 - Center align
            escpos_data.push_back(0x1B);
            escpos_data.push_back(0x61);
            escpos_data.push_back(0x01);

            ESPTime now = id(sntp_time).now();

            std::string time = now.strftime("\nAm %d.%m.%Y um %H:%M reinigte ");
            escpos_data.insert(escpos_data.end(), time.begin(), time.end());

            escpos_data.insert(escpos_data.end(), name.begin(), name.end());

            std::string text = " die Maschine. Ehre!\n";
            escpos_data.insert(escpos_data.end(), text.begin(), text.end());

            std::string coffees_text = "Es wurden " + std::to_string(id(coffees_since_last_cleaning)) + " Kaffees seit der letzten Reinigung gemacht.\n";
            escpos_data.insert(escpos_data.end(), coffees_text.begin(), coffees_text.end());

            std::string time2 = id(last_cleaning_time).strftime("Die letzte Reinigung fand am %d.%m.%Y um %H:%M statt.\n");
            escpos_data.insert(escpos_data.end(), time2.begin(), time2.end());

            id(last_cleaning_time) = now;
            id(coffees_since_last_cleaning) = 0;

            // ESC a 0 - Left align
            escpos_data.push_back(0x1B);
            escpos_data.push_back(0x61);
            escpos_data.push_back(0x00);

            return escpos_data;
      - script.wait: transmit_print
      - script.execute: print_cleaning_report

  - id: log_refill
    then:
      - logger.log: "Logging Coffee Refill"
      - rtttl.play: "two_short:d=4,o=5,b=100:16e6,16e6"
      - lambda: |-
          id(total_refills) += 1;
      # Notify BLE clients of updated values
      - ble_server.characteristic.notify:
          id: ble_total_refills
      - script.wait: transmit_print
      - script.execute:
          id: transmit_print
          message: !lambda |-
            std::vector<uint8_t> escpos_data;

            //// ESC @ - Initialize printer
            escpos_data.push_back(0x1B);
            escpos_data.push_back(0x40);

            // ESC a 1 - Center align
            escpos_data.push_back(0x1B);
            escpos_data.push_back(0x61);
            escpos_data.push_back(0x01);

            ESPTime now = id(sntp_time).now();

            std::string header = "\n=== KAFFEE NACHGEFUELLT ===\n\n";
            escpos_data.insert(escpos_data.end(), header.begin(), header.end());

            std::string time = now.strftime("Am %d.%m.%Y um %H:%M\n");
            escpos_data.insert(escpos_data.end(), time.begin(), time.end());

            std::string refill_count = "Nachfuellung #" + std::to_string(id(total_refills)) + "\n\n";
            escpos_data.insert(escpos_data.end(), refill_count.begin(), refill_count.end());

            std::string coffees_text = "Seit letzter Nachfuellung:\n" + std::to_string(id(coffees_since_last_refill)) + " Kaffees gemacht\n";
            escpos_data.insert(escpos_data.end(), coffees_text.begin(), coffees_text.end());

            if (id(last_refill_time).is_valid()) {
              std::string last_refill = id(last_refill_time).strftime("\nLetzte Nachfuellung:\n%d.%m.%Y um %H:%M\n");
              escpos_data.insert(escpos_data.end(), last_refill.begin(), last_refill.end());
            }

            // ESC a 0 - Left align
            escpos_data.push_back(0x1B);
            escpos_data.push_back(0x61);
            escpos_data.push_back(0x00);

            return escpos_data;
      - script.wait: transmit_print
      - if:
          condition:
            lambda: "return id(coffees_since_last_refill) > 0;"
          then:
            - script.execute:
                id: transmit_print
                message: !lambda 'return generate_report("NACHFUELLUNGS-PERIODE", id(coffees_since_last_refill), "Kaffees", id(names), id(refill_period_consumptions), id(cleanings), id(consumption_times), id(total_names));'
            - script.wait: transmit_print
      - lambda: |-
          // Reset refill period tracking
          id(last_refill_time) = id(sntp_time).now();
          id(coffees_since_last_refill) = 0;
          for (size_t i = 0; i < id(refill_period_consumptions).size(); i++) {
            id(refill_period_consumptions)[i] = 0;
          }
      # Notify BLE clients of updated values
      - ble_server.characteristic.notify:
          id: ble_last_refill_time
      - ble_server.characteristic.notify:
          id: ble_coffees_since_refill

  - id: log_coffee
    parameters:
      name: string
    then:
      - light.turn_on:
          id: led
          brightness: 100%
          red: 100%
          green: 100%
          blue: 100%
          flash_length: 500ms
      - logger.log: "Logging Coffee Consumption"
      - rtttl.play: "success:d=24,o=5,b=100:c,g,b"
      #- script.execute:
      #    id: transmit_print
      #    message: !lambda "return {0x1b, 0x40};"
      #- script.wait: transmit_print
      #- delay: 200ms
      - lambda: |-
          size_t name_index = get_name_index(id(names), name);
          if (name_index == -1) {
            name_index = id(total_names)++;
            id(names)[name_index].set_name(name.c_str());
          }
          id(consumptions)[name_index]++;
          id(consumption_times)[name_index] = id(sntp_time).now();
          id(refill_period_consumptions)[name_index]++;
          id(total_consumptions) += 1;
          id(coffees_since_last_cleaning) += 1;
          id(coffees_since_last_refill) += 1;
      # Notify BLE clients of updated values
      - ble_server.characteristic.notify:
          id: ble_total_consumptions
      - ble_server.characteristic.notify:
          id: ble_coffees_since_cleaning
      - ble_server.characteristic.notify:
          id: ble_coffees_since_refill
      - script.wait: transmit_print
      - script.execute:
          id: transmit_print
          message: !lambda |-
            std::vector<uint8_t> escpos_data;

            // ESC @ - Initialize printer
            escpos_data.push_back(0x1B);
            escpos_data.push_back(0x40);

            if (id(new_day)) {
              std::string date = id(sntp_time).now().strftime("%d.%m.%Y:\n");
              escpos_data.insert(escpos_data.end(), date.begin(), date.end());
              id(new_day) = false;
            }
            std::string time = id(sntp_time).now().strftime("> %H:%M: ");
            escpos_data.insert(escpos_data.end(), time.begin(), time.end());

            escpos_data.insert(escpos_data.end(), name.begin(), name.end());

            std::string text = "\n";
            escpos_data.insert(escpos_data.end(), text.begin(), text.end());

            return escpos_data;

      - script.wait: transmit_print
      - if:
          condition:
            lambda: "return id(total_consumptions) % ${consumptions_until_report} == 0;"
          then:
            - script.execute: print_consumption_report

  - id: print_consumption_report
    then:
      - logger.log: "Printing consumption report"
      - script.wait: transmit_print
      - script.execute:
          id: transmit_print
          message: !lambda 'return generate_report("KAFFEE REPORT", id(total_consumptions), "Kaffees", id(names), id(consumptions), id(cleanings), id(consumption_times), id(total_names));'
      - script.wait: transmit_print

  - id: print_cleaning_report
    then:
      - logger.log: "Printing cleaning report"
      - script.wait: transmit_print
      - script.execute:
          id: transmit_print
          message: !lambda 'return generate_cleaning_report("REINIGUNGS REPORT", id(total_cleanings), "Reinigungen", id(names), id(cleanings), id(consumptions), id(cleaning_times), id(total_names));'
      - script.wait: transmit_print

status_led:
  pin:
    number: GPIO8
    inverted: true
